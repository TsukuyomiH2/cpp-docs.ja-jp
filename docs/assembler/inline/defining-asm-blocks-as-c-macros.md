---
title: __asm ブロックの C マクロとしての定義
ms.date: 08/30/2018
helpviewer_keywords:
- macros, __asm blocks
- Visual C, macros
- __asm keyword [C++], as C macros
ms.assetid: 677ba11c-21c8-4609-bba7-cd47312243b0
ms.openlocfilehash: 46f0a23fcfd949843e3548354f52970b10b6d63b
ms.sourcegitcommit: 857fa6b530224fa6c18675138043aba9aa0619fb
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/24/2020
ms.locfileid: "80169488"
---
# <a name="defining-__asm-blocks-as-c-macros"></a>__asm ブロックの C マクロとしての定義

**Microsoft 固有の仕様**

C マクロは、ソースコードにアセンブリコードを挿入する便利な方法を提供しますが、マクロが1つの論理行に展開されるため、特別な注意が必要です。 問題のないマクロを作成するには、次の規則に従います。

- `__asm` ブロックを中かっこで囲みます。

- 各アセンブリ命令の前に `__asm` キーワードを配置します。

- アセンブリスタイルのコメント (`; comment`) または単一行の C コメント (`// comment`) の代わりに、旧形式の C コメント (`/* comment */`) を使用します。

例を示すために、次の例では単純なマクロを定義します。

```cpp
#define PORTIO __asm      \
/* Port output */         \
{                         \
   __asm mov al, 2        \
   __asm mov dx, 0xD007   \
   __asm out dx, al       \
}
```

一見すると、最後の3つの `__asm` キーワードは不要に見えます。 ただし、マクロは1行に展開されるため、必要になります。

```cpp
__asm /* Port output */ { __asm mov al, 2  __asm mov dx, 0xD007 __asm out dx, al }
```

3番目と4番目の `__asm` キーワードは、ステートメントの区切り記号として必要です。 `__asm` ブロックで認識されるステートメント区切り記号は、改行文字と `__asm` キーワードのみです。 マクロとして定義されたブロックは1つの論理行であるため、各命令を `__asm`で区切る必要があります。

中かっこも必要です。 これらを省略した場合、C またはC++マクロ呼び出しの右側と同じ行にあるステートメントによって、コンパイラが混乱する可能性があります。 右中かっこを使用しない場合、コンパイラはアセンブリコードが停止する場所を認識C++できず、C またはステートメントがアセンブリ命令として `__asm` ブロックの後に表示されます。

セミコロン ( **;** ) で始まるアセンブリスタイルのコメントは、行の末尾に続きます。 これにより、マクロで問題が発生します。これは、コンパイラがコメントの後にあるすべてのものを、論理行の末尾まで無視するためです。 単一行の C またはC++コメント (`// comment`) にも同じことが当てはまります。 エラーを回避するには、マクロとして定義されている `__asm` ブロックで、旧形式の C コメント (`/* comment */`) を使用します。

C マクロとして記述された `__asm` ブロックは、引数を受け取ることができます。 ただし、通常の C マクロとは異なり、`__asm` マクロは値を返すことができません。 そのため、C やC++式ではこのようなマクロを使用できません。

この型のマクロをむやみに呼び出さないように注意してください。 たとえば、`__fastcall` 規約で宣言された関数でアセンブリ言語マクロを呼び出すと、予期しない結果が発生する可能性があります。 (「[インラインアセンブリでのレジスタの使用と保持」を](../../assembler/inline/using-and-preserving-registers-in-inline-assembly.md)参照してください)。

**Microsoft 固有の仕様はここまで**

## <a name="see-also"></a>参照

[インライン アセンブラー](../../assembler/inline/inline-assembler.md)<br/>
