---
title: __asm ブロックの C マクロとしての定義
ms.date: 08/30/2018
helpviewer_keywords:
- macros, __asm blocks
- Visual C, macros
- __asm keyword [C++], as C macros
ms.assetid: 677ba11c-21c8-4609-bba7-cd47312243b0
ms.openlocfilehash: 4195624078c53f6c1f20cd2a03ed53dac937d9cd
ms.sourcegitcommit: 1f009ab0f2cc4a177f2d1353d5a38f164612bdb1
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/27/2020
ms.locfileid: "87192107"
---
# <a name="defining-__asm-blocks-as-c-macros"></a>__asm ブロックの C マクロとしての定義

**Microsoft 固有の仕様**

C マクロは、ソースコードにアセンブリコードを挿入する便利な方法を提供しますが、マクロが1つの論理行に展開されるため、特別な注意が必要です。 問題のないマクロを作成するには、次の規則に従います。

- ブロックは **`__asm`** 中かっこで囲みます。

- **`__asm`** 各アセンブリ命令の前にキーワードを配置します。

- `/* comment */`アセンブリスタイルのコメント () または単一行の c コメント () の代わりに、旧形式の c コメント () を使用 `; comment` `// comment` します。

例を示すために、次の例では単純なマクロを定義します。

```cpp
#define PORTIO __asm      \
/* Port output */         \
{                         \
   __asm mov al, 2        \
   __asm mov dx, 0xD007   \
   __asm out dx, al       \
}
```

一見すると、最後の3つの **`__asm`** キーワードは余分に見えます。 ただし、マクロは1行に展開されるため、必要になります。

```cpp
__asm /* Port output */ { __asm mov al, 2  __asm mov dx, 0xD007 __asm out dx, al }
```

3番目と4番目のキーワードは、 **`__asm`** ステートメントの区切り記号として必要です。 ブロックで認識されるステートメント区切り記号は、 **`__asm`** 改行文字と **`__asm`** キーワードだけです。 マクロとして定義されたブロックは1つの論理行であるため、各命令をで区切る必要があり **`__asm`** ます。

中かっこも必要です。 これらを省略した場合、コンパイラは、マクロ呼び出しの右側と同じ行にある C または C++ のステートメントによって混乱する可能性があります。 右中かっこを使用しない場合、コンパイラはアセンブリコードが停止する場所を認識できず、ブロックの後に C または C++ のステートメントが **`__asm`** アセンブリ命令として表示されます。

セミコロン (**;**) で始まるアセンブリスタイルのコメントは、行の末尾に続きます。 これにより、マクロで問題が発生します。これは、コンパイラがコメントの後にあるすべてのものを、論理行の末尾まで無視するためです。 これは、単一行の C または C++ のコメント () にも当てはまり `// comment` ます。 エラーを回避するには、 `/* comment */` **`__asm`** マクロとして定義されているブロックで、旧形式の C コメント () を使用します。

**`__asm`** C マクロとして記述されたブロックは、引数を受け取ることができます。 ただし、通常の C マクロとは異なり、 **`__asm`** マクロは値を返すことはできません。 そのため、C または C++ の式ではこのようなマクロを使用できません。

この型のマクロをむやみに呼び出さないように注意してください。 たとえば、規則で宣言された関数でアセンブリ言語マクロを呼び出すと、 **`__fastcall`** 予期しない結果が発生する可能性があります。 (「[インラインアセンブリでのレジスタの使用と保持」を](../../assembler/inline/using-and-preserving-registers-in-inline-assembly.md)参照してください)。

**Microsoft 固有の仕様はここまで**

## <a name="see-also"></a>関連項目

[インラインアセンブラー](../../assembler/inline/inline-assembler.md)<br/>
