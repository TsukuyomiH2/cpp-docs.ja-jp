---
title: 'TN040: MFC-OLE インプレースサイズとズーム'
ms.date: 11/04/2016
helpviewer_keywords:
- resizing in-place
- TN040
- zooming and in-place activation
- in-place activation, zooming and resizing
ms.assetid: 4d7859bd-0b2e-4254-be62-2735cecf02c6
ms.openlocfilehash: 65f9ef04c9740e8e6f0a8e72d9d6c39008198755
ms.sourcegitcommit: c123cc76bb2b6c5cde6f4c425ece420ac733bf70
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/14/2020
ms.locfileid: "81372166"
---
# <a name="tn040-mfcole-in-place-resizing-and-zooming"></a>テクニカル ノート 40: MFC/OLE 埋め込み先サイズ変更とズーム

> [!NOTE]
> 次のテクニカル ノートは、最初にオンライン ドキュメントの一部とされてから更新されていません。 結果として、一部のプロシージャおよびトピックが最新でないか、不正になります。 最新の情報について、オンライン ドキュメントのキーワードで関係のあるトピックを検索することをお勧めします。

このノートでは、インプレース編集に関する問題と、サーバーが正しいズームとインプレースサイズをどのように実現すべきかについて説明します。 一括アクティブ化では、WYSIWYG の概念は、コンテナーとサーバーが相互に連携し、特に、ほとんど同じ方法で OLE 仕様を解釈する 1 つのステップを取ります。

コンテナーとサーバー間の密接な対話が埋め込み可能なアクティブ化をサポートしているため、エンド ユーザーからは、次のことが期待されています。

- プレゼンテーション表示 (`COleServerItem::OnDraw`オーバーライドで描画されるメタファイル) は、編集用に描画されるときとまったく同じになります (編集ツールが表示されない点を除く)。

- コンテナがズームすると、サーバーウィンドウも表示されます。

- コンテナとサーバーの両方に、同じメトリックを使用して編集用のオブジェクトを表示する必要があります。 つまり、ディスプレイ デバイスでレンダリングする場合、1 インチあたりの*論理*ピクセル数 (1 インチあたりの物理ピクセルではない) に基づくマッピング モードを使用します。

> [!NOTE]
> 埋め込み先編集の有効化は、埋め込み (リンクされていない) アイテムにのみ適用されるため、ズームは埋め込みオブジェクトにのみ適用されます。 両方に API が表示`COleServerDoc`され`COleServerItem`、ズームに使用されます。 この二分法の理由は、リンクされたアイテムと埋め込みアイテムの両方に有効な関数`COleServerItem`のみが内にあり(これは共通の実装を持つことができます)、埋め込みオブジェクトに対してのみ有効な`COleServerDoc`関数がクラスに配置されているからです(サーバーの観点から見ると、それは埋め込まれている**ドキュメント**です)。

サーバーは、コンテナのズーム係数を認識し、必要に応じて編集インターフェイスを変更する必要があるという点で、サーバーの実装者に負担をかけるのが大半です。 しかし、コンテナが使用しているズーム係数をサーバはどのように決定するのか

## <a name="mfc-support-for-zooming"></a>ズームの MFC サポート

現在のズーム倍率は、 を`COleServerDoc::GetZoomFactor`呼び出すことによって決定できます。 ドキュメントがインプレースアクティブでないときにこれを呼び出すと、常に 100% のズーム係数 (または 1:1 の比率) になります。 インプレース アクティブのときに呼び出すと、100% 以外の値が返される場合があります。

ズームの例については、MFC OLE サンプル[HIERSVR](../overview/visual-cpp-samples.md)を参照してください。 HIERSVRのズームはテキストを表示し、テキストは一般的に線形で拡大縮小されないという事実によって複雑です(ヒント、タイポグラフィの規則、デザインの幅、高さはすべて問題を複雑にします)。 それでも、HIERSVR は、正しくズームを実装するための妥当なリファレンスであり、MFC チュートリアル[SCRIBBLE](../overview/visual-cpp-samples.md) (手順 7) も実装します。

`COleServerDoc::GetZoomFactor`では、コンテナまたはクラスの実装から利用できるさまざまなメトリックに基づいて、ズーム係数が`COleServerItem`決定`COleServerDoc`されます。 つまり、現在のズーム倍率は次の式によって決定されます。

```
Position Rectangle (PR) / Container Extent (CE)
```

位置矩形はコンテナによって決定されます。 インプレース アクティブ化の際にサーバーに返`COleClientItem::OnGetItemPosition`され、コンテナーがサーバーの呼び出し`COleServerDoc::OnSetItemRects`を呼び出すと更新されます`COleClientItem::SetItemRects`(呼び出しを行います)。

コンテナーの範囲は、計算する少し複雑です。 コンテナーが呼び出`COleServerItem::OnSetExtent`しを行った場合`COleClientItem::SetExtent`(呼び出しを行う) 場合、CONTAINER EXTENT は、論理インチあたりのピクセル数に基づいて、この値をピクセルに変換します。 コンテナが SetExtent を呼び出していない場合 (通常はそうです)、コンテナの EXTENT`COleServerItem::OnGetExtent`は から返されるサイズです。 したがって、コンテナーが SetExtent を呼び出していない場合、フレームワークは、コンテナーが自然なエクステント (から`COleServerItem::GetExtent`返される値) の 100% で呼び出したと想定します。 別の言い方をすると、フレームワークは、コンテナーがアイテムの 100% (これ以上、それ以下) を表示していると仮定します。

名前は似ていますが`COleServerItem::OnSetExtent``COleServerItem::OnGetExtent`、項目の同じ属性を操作しないことに注意してください。 `OnSetExtent`は、オブジェクトのサイズを (ズーム係数に関係なく) コンテナー内で表示されるオブジェクトの量をサーバー`OnGetExtent`に知らせるために呼び出され、オブジェクトの理想的なサイズを決定するためにコンテナーによって呼び出されます。

関連する API のそれぞれを見ると、より明確な画像を得ることができます。

## <a name="coleserveritemongetextent"></a>を選択します。

この関数は、アイテムの HIMETRIC 単位で「自然サイズ」を返す必要があります。 「自然サイズ」を考える最善の方法は、印刷時に表示されるサイズとして定義することです。 ここで返されるサイズは、特定の項目の内容に対して一定です (メタファイルと同様に、特定の項目の場合は一定です)。 このサイズは、アイテムにズームを適用しても変更されません。 通常、コンテナーがを呼び出`OnSetExtent`して項目に多かれ少なかれ空き領域を与えた場合、この値は変更されません。 変更の例としては、コンテナーから最後に送信された範囲に基づいてテキストを折り返す「余白」機能を持たない単純なテキスト エディターの変更があります。 サーバーが変更された場合、サーバーはシステム レジストリにOLEMISC_RECOMPOSEONRESIZE ビットを設定する必要があります (このオプションの詳細については、OLE SDK のドキュメントを参照してください)。

## <a name="coleserveritemonsetextent"></a>をクリックします。

この関数は、コンテナがオブジェクトの "多かれ少なかれ" と表示されたときに呼び出されます。 ほとんどのコンテナはこれをまったく呼び出しません。 デフォルトの実装では、コンテナから最後に受け取った値を'm_sizeExtent' に`COleServerDoc::GetZoomFactor`格納します。

## <a name="coleserverdoconsetitemrects"></a>をクリックします。

この関数は、ドキュメントがインプレースアクティブの場合にのみ呼び出されます。 コンテナーがアイテムの位置またはアイテムに適用されたクリッピングを更新するときに呼び出されます。 上で説明したように、位置矩形は、ズーム率計算のための分子を提供します。 サーバーは、 を呼び出`COleServerDoc::RequestPositionChange`してアイテムの位置を変更するよう要求できます。 コンテナーは呼び出しによってこの要求に応答する`OnSetItemRects`場合と応答しない場合`COleServerItem::SetItemRects`があります ( 呼び出しを使用して ) 。

## <a name="coleserverdocondraw"></a>コレクサーバードック::オンドロー

オーバーライドによって作成されたメタファイルは、現在の`COleServerItem::OnDraw`ズーム倍率に関係なく、まったく同じメタファイルを生成することを認識することが重要です。 コンテナは、必要に応じてメタファイルをスケーリングします。 これは、ビューとサーバーアイテムの`OnDraw`重要な違いです。 `OnDraw` ビューはズームを処理し、アイテムは*ズーム可能な*メタファイルを作成し、適切なズームを行うためにコンテナに任せます。

サーバーが正しく動作することを保証する最善の方法は、ドキュメントがインプレースアクティブ`COleServerDoc::GetZoomFactor`である場合の実装を使用することです。

## <a name="mfc-support-for-in-place-resizing"></a>MFC のインプレース サイズ変更のサポート

MFC は、OLE 2 仕様に記述されているように、インプレース リサイズ インターフェイスを完全に実装します。 ユーザー インターフェイスは、`COleResizeBar`クラス、カスタム メッセージ WM_SIZECHILD、および このメッセージの特別な処理によって`COleIPFrameWnd`サポートされています。

このメッセージの処理は、フレームワークによって提供されるものとは異なる処理を実装する場合があります。 前述のように、フレームワークは、インプレース サイズの結果をコンテナーに残します— サーバーは、ズーム倍率の変化に応答します。 コンテナーの処理中にコンテナーの EXTENT と位置の両方の四角形`COleClientItem::OnChangeItemPosition`を設定して反応する場合 (呼び出し`COleServerDoc::RequestPositionChange`の結果として呼び出されます)、インプレース のサイズ変更は、編集ウィンドウで項目の"多かれ少なかれ"を表示します。 の処理中`COleClientItem::OnChangeItemPosition`に POSITION RECTANGLE を設定するだけでコンテナが反応する場合、ズーム倍率が変化し、項目が「ズームインまたはズームアウト」と表示されます。

サーバーは、このネゴシエーション中に何が起こるかをある程度制御できます。 たとえば、スプレッドシートでは、アイテムをインプレースで編集しているときにユーザーがウィンドウのサイズを変更したときに、表示するセルの数を増減します。 ワード プロセッサは、ウィンドウと同じページ余白を変更し、テキストを新しい余白に再折り返すことを選択する場合があります。 サーバーは、サイズ変更が完了したときに自然な範囲 (`COleServerItem::OnGetExtent`から返されるサイズ ) を変更することによってこれを実装します。 これにより、位置の四角形とコンテナーの範囲の両方が同じ量に変化し、同じズーム倍率が、拡大または縮小表示領域になります。 さらに、ドキュメントの多かれ少なかれ、によって生成されたメタファイルに表示されます`OnDraw`。 この場合、表示領域だけでなく、ユーザーがアイテムのサイズを変更すると、ドキュメント自体が変化します。

カスタムサイズ変更を実装し、クラス内のWM_SIZECHILDメッセージをオーバーライド`COleResizeBar`することによって提供されるユーザー インターフェイスを活用`COleIPFrameWnd`できます。 WM_SIZECHILDの詳細については、[テクニカル ノート 24](../mfc/tn024-mfc-defined-messages-and-resources.md)を参照してください。

## <a name="see-also"></a>関連項目

[番号順テクニカル ノート](../mfc/technical-notes-by-number.md)<br/>
[カテゴリ別テクニカル ノート](../mfc/technical-notes-by-category.md)
