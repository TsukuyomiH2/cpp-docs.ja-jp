---
title: /kernel (カーネル モード バイナリの作成)
description: Microsoft C/c + + コンパイラ/kernel オプションは、カーネルモードで実行するためのプロジェクトをビルドおよびリンクします。
ms.date: 09/28/2020
f1_keywords:
- /kernel
- /kernel-
ms.assetid: 6d7fdff0-c3d1-4b78-9367-4da588ce8b05
ms.openlocfilehash: 8a8c02a6f102a52afbc52c154ce215ede3f38f74
ms.sourcegitcommit: a1676bf6caae05ecd698f26ed80c08828722b237
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/29/2020
ms.locfileid: "91509348"
---
# <a name="kernel-create-kernel-mode-binary"></a>/kernel (カーネル モード バイナリの作成)

Windows カーネルで実行できるバイナリを作成します。 現在のプロジェクトのコードは、カーネルモードで実行されるコードに固有の C++ 言語機能の簡略化されたセットを使用してコンパイルおよびリンクされます。

## <a name="syntax"></a>構文

> **`/kernel`**

## <a name="remarks"></a>解説

オプションを指定する **`/kernel`** と、カーネルモードで許容される言語機能を判別し、カーネルモード C++ に固有のランタイムの不安定性を回避するのに十分な表現力を持つようにコンパイラとリンカーに指示します。 これは、カーネルモードの中断を伴う C++ 言語機能の使用を禁止することによって行われます。 コンパイラは、中断される可能性があるが、無効にできない可能性がある C++ 言語機能に対して警告を生成します。

この **`/kernel`** オプションは、ビルドのコンパイラフェーズとリンカーフェーズの両方に適用され、プロジェクトレベルで設定されます。 スイッチを渡して、 **`/kernel`** リンク後のバイナリを Windows カーネルに読み込む必要があることをコンパイラに示します。 コンパイラは、C++ 言語機能の範囲をカーネルと互換性のあるサブセットに絞り込みます。

次の表に、を指定した場合のコンパイラ動作の変更を示し **`/kernel`** ます。

| 動作の種類 | **`/kernel`** 挙動 |
|--|--|
| C++ 例外処理 | 無効にします。 キーワードとキーワードのすべてのインスタンスは、 **`throw`** **`try`** コンパイラエラーを生成します (例外指定は除き `throw()` ます)。 と互換性のあるオプションはありません **`/EH`** **`/kernel`** 。ただし、は除き **`/EH-`** ます。 |
| RTTI | 無効にします。 **`dynamic_cast`** が静的に使用されていない限り、キーワードとキーワードのすべてのインスタンスは **`typeid`** コンパイラエラーを生成し **`dynamic_cast`** ます。 |
| `new` および `delete` | または演算子を明示的に定義する必要があり `new()` `delete()` ます。 コンパイラとランタイムは、既定の定義を提供しません。 |

オプションを使用する場合、カスタム呼び出し規則、 [`/GS`](gs-buffer-security-check.md) ビルドオプション、およびすべての最適化が許可され **`/kernel`** ます。 インライン展開は、コンパイラによって実現されるのと同じセマンティクスを使用して、主にによる影響を受けません **`/kernel`** 。 インライン展開の修飾子が有効になっていることを確認するには **`__forceinline`** 、特定の関数がインライン化されていないことを通知するように、警告 [C4714](../../error-messages/compiler-warnings/compiler-warning-level-4-c4714.md) が有効になっていることを確認する必要があり **`__forceinline`** ます。

`#pragma`このオプションを制御するための同等の機能はありません。

コンパイラにスイッチが渡されると **`/kernel`** 、事前という名前のプリプロセッサマクロが生成され、 `_KERNEL_MODE` 値 **1**が与えられます。 このマクロを使用すると、実行環境がユーザーモードとカーネルモードのどちらであるかに基づいて、条件に応じてコードをコンパイルできます。 たとえば、次のコードでは、 `MyNonPagedClass` カーネルモードの実行用にコンパイルされるときに、クラスを非ページングメモリセグメントに配置するように指定しています。

```cpp
#ifdef _KERNEL_MODE
#define NONPAGESECTION __declspec(code_seg("$kerneltext$"))
#else
#define NONPAGESECTION
#endif

class NONPAGESECTION MyNonPagedClass
{
   // ...
};
```

次に示すターゲットアーキテクチャとオプションの組み合わせの一部では、 **`/arch`** での使用時にエラーが発生し **`/kernel`** ます。

- **`/arch:SSE`** x86 では、、、 **`/arch:SSE2`** **`/arch:AVX`** 、 **`/arch:AVX2`** 、およびは **`/arch:AVX512`** サポートされていません。 **`/arch:IA32`** X86 上のでのみサポートされてい **`/kernel`** ます。

- **`/arch:AVX`** x64 では、、 **`/arch:AVX2`** 、およびは **`/arch:AVX512`** サポートされていません **`/kernel`** 。

を使用したビルド **`/kernel`** **`/kernel`** は、リンカーにも渡します。 このオプションがリンカーの動作に与える影響を次に示します。

- インクリメンタルリンクは無効です。 を **`/incremental`** コマンドラインに追加すると、リンカーは次のような致命的なエラーを出力します。

   **致命的なエラー LNK1295: '/INCREMENTAL ' は '/KERNEL ' 仕様と互換性がありません。'/INCREMENTAL ' のないリンク**

- リンカーは、各オブジェクトファイル (またはスタティックライブラリの含まれているすべてのアーカイブメンバー) を検査し、オプションを使用してコンパイルされた可能性があるかどうかを確認し **`/kernel`** ます。 次の表に示すように、いずれかのインスタンスがこの条件を満たしている場合でも、リンカーは正常にリンクされますが、警告が発行される可能性があります。

   | command | **`/kernel`** obj | 非 **`/kernel`** obj、MASM obj、または cvtres obj | **`/kernel`** と非 obj の組み合わせ **`/kernel`** |
   |--|--|--|--|
   | **`link /kernel`** | はい | はい | はい (警告 LNK4257 あり) |
   | **`link`** | はい | はい | はい |

   **LNK4257 リンクオブジェクトが/KERNEL でコンパイルされていません。イメージは実行されない可能性があります**

**`/kernel`** オプションとオプションは、 **`/driver`** それぞれ独立して動作します。 互いに影響を与えることはありません。

### <a name="to-set-the-kernel-compiler-option-in-visual-studio"></a>/Kernel コンパイラオプションを Visual Studio で設定するには

1. プロジェクトの **[プロパティ ページ]** ダイアログ ボックスを開きます。 詳しくは、「[Visual Studio で C++ コンパイラとビルド プロパティを設定する](../working-with-project-properties.md)」をご覧ください。

1. [**構成プロパティ**] [  >  **C/c + +**  >  **コマンドライン**] プロパティページを選択します。

1. [ **追加オプション** ] ボックスで、を追加 *`/kernel`* します。 **[OK]** または [**適用**] を選択して、変更を保存します。

## <a name="see-also"></a>関連項目

[MSVC コンパイラオプション](compiler-options.md)\
[MSVC コンパイラのコマンドライン構文](compiler-command-line-syntax.md)
