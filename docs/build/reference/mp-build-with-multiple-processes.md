---
description: 詳細情報:/MP (複数のプロセスを使用したビルド)
title: /MP (複数のプロセスを使用したビルド)
ms.date: 04/08/2019
f1_keywords:
- VC.Project.VCCLCompilerTool.MultiProcessorCompilation
helpviewer_keywords:
- -MP compiler option (C++)
- /MP compiler option (C++)
- MP compiler option (C++)
- cl.exe compiler, multi-process build
ms.openlocfilehash: d5d4441be505dfc1251b099aa95a6ce1544289ad
ms.sourcegitcommit: d6af41e42699628c3e2e6063ec7b03931a49a098
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/11/2020
ms.locfileid: "97137788"
---
# <a name="mp-build-with-multiple-processes"></a>/MP (複数のプロセスを使用したビルド)

**/MP** オプションは、コマンドラインでソース ファイルをコンパイルするための合計時間を短縮できます。 **/MP** オプションによって、コンパイラは 1 つまたは複数のそれ自身のコピーを、それぞれ別のプロセスで作成できます。 これらのコピーで、同時にソース ファイルをコンパイルします。 その結果、ソース ファイルをビルドするための合計時間を大幅に短縮することができます。

## <a name="syntax"></a>構文

> **/Mp**[*processMax*]

## <a name="arguments"></a>引数

*processMax*<br/>
(省略可能) コンパイラが作成できるプロセスの最大数。

*ProcessMax* 引数は、1 ~ 65536 の範囲で指定する必要があります。 それ以外の場合、コンパイラは警告メッセージ **D9014** を発行し、 *processMax* 引数を無視し、プロセスの最大数が1であると想定します。

*ProcessMax* 引数を省略した場合、コンパイラはコンピューター上の [有効なプロセッサ](#effective_processors)の数をオペレーティングシステムから取得し、プロセッサごとにプロセスを作成します。

## <a name="remarks"></a>解説

**/MP** コンパイラ オプションは、多くのファイルをコンパイルするときに、ビルド時間を大幅に短縮できます。 ビルド時間を向上させるために、コンパイラはそれ自身のコピーを *processMax* に作成し、それらのコピーを使用して同時にソースファイルをコンパイルします。 **/MP** オプションはコンパイルに適用されますが、リンクやリンク時のコード生成には適用されません。 既定では、 **/MP** オプションはオフです。

ビルド時間の向上は、コンピューター上のプロセッサ数、コンパイルするファイルの数、および I/O 容量などのシステム リソースの可用性に依存します。 **/MP** オプションを試して、特定のプロジェクトをビルドするのに最適な設定を確認してください。 この判断を行う際に役立つアドバイスについては、 [ガイドライン](#guidelines)をご覧ください。

## <a name="incompatible-options-and-language-features"></a>互換性のないオプションと言語機能

**/MP** オプションは一部のコンパイラ オプションや言語機能と互換性がありません。 互換性のないコンパイラオプションを **/mp** オプションと共に使用すると、コンパイラは警告 **D9030** を発行し、 **/mp** オプションを無視します。 互換性のない言語機能を使用すると、コンパイラは、現在のコンパイラの警告レベルオプションに応じて、エラー [C2813](../../error-messages/compiler-errors-2/compiler-error-c2813.md) を発行して終了または続行します。

> [!NOTE]
> ほとんどのオプションは、許可されると、同時に実行される複数のコンパイラによって、コンソールや特定のファイルに同時に出力が書き込まれることになるため、互換性がありません。 その結果、出力にさまざまな情報が混在し、文字が正しく表示されません。 オプションの組み合わせによっては、パフォーマンスが低下する場合もあります。

次の表に、 **/MP** オプションと互換性のないコンパイラ オプションや言語機能を示します。

|オプションまたは言語機能|説明|
|--------------------------------|-----------------|
|[#import](../../preprocessor/hash-import-directive-cpp.md) プリプロセッサ ディレクティブ|タイプ ライブラリの型を C++ クラスに変換し、それらのクラスをヘッダー ファイルに書き込みます。|
|[/E](e-preprocess-to-stdout.md)、 [/EP](ep-preprocess-to-stdout-without-hash-line-directives.md)|プリプロセッサ出力を標準出力 (**stdout**) にコピーします。|
|[/Gm](gm-enable-minimal-rebuild.md)|非推奨になりました。 インクリメンタル リビルドを有効にします。|
|[/showIncludes](showincludes-list-include-files.md)|インクルード ファイルのリストを標準エラー出力 (**stderr**) に書き込みます。|
|[/Yc](yc-create-precompiled-header-file.md)|プリコンパイル済みヘッダー ファイルを書き込みます。|

## <a name="diagnostic-messages"></a>診断メッセージ

**/MP** オプションと互換性がないオプションまたは言語機能を指定した場合、診断メッセージが表示されます。 次の表に、メッセージと、コンパイラの動作を示します。

|診断メッセージ|説明|コンパイラの動作|
|------------------------|-----------------|-----------------------|
|**C2813**|**#import** ディレクティブは **/MP** オプションと互換性がありません。|[コンパイラの警告レベル](compiler-option-warning-level.md) オプションで他の方法が指定されている場合を除き、コンパイルは終了します。|
|**D9014**|*ProcessMax* 引数に無効な値が指定されています。|コンパイラは、無効な値を無視し、値が 1 であると見なします。|
|**D9030**|指定されたオプションは **/MP** オプションと互換性がありません。|コンパイラは **/MP** オプションを無視します。|

## <a name="guidelines"></a><a name="guidelines"></a> ガイドライン

### <a name="measure-performance"></a>パフォーマンスの計測

合計ビルド時間を使用して、パフォーマンスを計測します。 物理クロックを使用してビルド時間を計測することも、ソフトウェアを使用してビルドの開始時と停止時の差を計算することもできます。 お使いのコンピューターに複数のプロセッサがある場合は、ソフトウェアによる時間の計測よりも、物理クロックの方がより正確な計測結果が生成される可能性があります。

### <a name="effective-processors"></a><a name="effective_processors"></a> Effective Processors

コンピューターには、それぞれの物理プロセッサに対して、 *有効なプロセッサ* とも呼ばれる1つ以上の仮想プロセッサを含めることができます。 各物理プロセッサは 1 つまたは複数のコアを持つことができ、オペレーティング システムでコアのハイパースレッディングが有効になっている場合、各コアは 2 つの仮想プロセッサとして表示されます。

たとえば、コンピューターに 1 つのコアを持つ物理プロセッサが 1 つ搭載されており、ハイパースレッディングが無効になっている場合、有効なプロセッサは 1 つです。 これに対し、コンピューターに 2 つの物理プロセッサがあり、それぞれが 2 つのコアを持ち、すべてのコアのハイパースレッディングが有効になっている場合、コンピューターの有効なプロセッサは 8 つになります。 つまり、(8 つの有効なプロセッサ) = (2 物理プロセッサ) x (物理プロセッサあたり2コア) x (ハイパースレッディングのため、コアあたり2つの有効なプロセッサ) x です。

**/Mp** オプションで *processMax* 引数を省略した場合、コンパイラはオペレーティングシステムから有効なプロセッサの数を取得し、有効なプロセッサごとに1つのプロセスを作成します。 ただし、コンパイラは特定のプロセッサでどのプロセスを実行するかを保証することはできません。この決定は、オペレーティング システムによって行われます。

### <a name="number-of-processes"></a>プロセス数

コンパイラは、ソース ファイルをコンパイルするために使用するプロセスの数を計算します。 この値は、コマンド ラインで指定したソース ファイルの数および **/MP** オプションで明示的または暗黙的に指定したプロセスの数より小さくなります。 **/Mp** オプションの *processMax* 引数を指定すると、プロセスの最大数を明示的に設定できます。 または、 *processMax* 引数を省略した場合は、既定のを使用できます。これは、コンピューター内の有効なプロセッサの数と同じです。

たとえば、次のようなコマンド ラインを指定したとします。

`cl /MP7 a.cpp b.cpp c.cpp d.cpp e.cpp`

この場合、コンパイラは、ソース ファイル数の 5 と最大プロセス数の 7 の小さい方である 5 つのプロセスを使用します。 また、コンピューターに 2 つの有効なプロセッサがあり、次のコマンド ラインを指定するとします。

`cl /MP a.cpp b.cpp c.cpp`

この場合、オペレーティング システムは 2 つのプロセッサを報告します。したがって、コンパイラは、その計算に 2 つのプロセスを使用します。 その結果、コンパイラは 2 つのプロセスでビルドを実行します。これは、プロセス数 2 とソース ファイル数 3 の小さい方であるためです。

### <a name="source-files-and-build-order"></a>ソース ファイルとビルド順序

ソース ファイルは、コマンド ラインで表示される順序と同じ順序でコンパイルされない可能性があります。 コンパイラは、コンパイラのコピーが含まれている一連のプロセスを作成しますが、オペレーティング システムが各プロセスを実行するタイミングをスケジュールします。 その結果、特定の順序でソース ファイルをコンパイルすることを保証できません。

ソース ファイルは、ソース ファイルをコンパイルするプロセスが利用可能になったときにコンパイルされます。 プロセスよりも多くのファイルがある場合は、利用可能なプロセスによってファイルの最初のセットがコンパイルされます。 残りのファイルは、プロセスが前のファイルの処理を終了し、残りのファイルのいずれかを処理できるようになると処理されます。

コマンド ラインで同じソース ファイルを複数回指定しないでください。 このような状況は、プロジェクト内の依存関係情報に基づいて、ツールが自動的に [makefile](contents-of-a-makefile.md) を作成する場合などに発生します。 **/MP** オプションを指定しない場合、コンパイラはファイルの一覧を順番に処理し、ファイルが出現するたびに再コンパイルします。 ただし、 **/MP** オプションを指定した場合、異なるコンパイラが同時に同じファイルをコンパイルする場合があります。 その結果、異なるコンパイラが、同時に同じ出力ファイルへの書き込みを試みます。 1 つのコンパイラは、出力ファイルへの排他書き込みアクセスを取得して成功し、他方のコンパイラは、ファイル アクセス エラーで失敗します。

### <a name="using-type-libraries-import"></a>タイプ ライブラリの使用 (#import)

コンパイラは、 [#import](../../preprocessor/hash-import-directive-cpp.md) ディレクティブを **/MP** スイッチと共に使用することはサポートしていません。 可能であれば、次の手順に従って、この問題を回避してください。

- さまざまなソース ファイル内の `#import` ディレクティブをすべて 1 つまたは複数のファイルに移動し、それらのファイルを **/MP** オプションを指定せずにコンパイルします。 これにより、一連のヘッダー ファイルが生成されます。

- 残りのソース ファイルで、生成されたヘッダーを指定する [#include](../../preprocessor/hash-include-directive-c-cpp.md) ディレクティブを挿入し、 **/MP** オプションを使用して残りのソース ファイルをコンパイルします。

### <a name="visual-studio-project-settings"></a>Visual Studio プロジェクトの設定

#### <a name="the-msbuildexe-tool"></a>MSBUILD.exe ツール

Visual Studio では、 [MSBuild.exe](/visualstudio/msbuild/msbuild-reference) ツールを使用してソリューションとプロジェクトをビルドします。 MSBuild.exe ツールの **/maxcpucount:**_number_ (または **/m:**_number_) コマンドラインオプションを使用すると、複数のプロジェクトを同時にビルドできます。 また、 **/MP** コンパイラ オプションによって、同時に複数のコンパイル ユニットをビルドすることができます。 アプリケーションで適切である場合は、 **/MP** と **/maxcpucount** のいずれかまたは両方を使用して、ソリューションのビルド時間を向上させてください。

ソリューションのビルド時間は、部分的に、ビルドを実行するプロセスの数に依存しています。 [/Maxcpucount](/visualstudio/msbuild/msbuild-command-line-reference) MSBuild オプションの *number* 引数は、同時にビルドするプロジェクトの最大数を指定します。 同様に、 **/mp** コンパイラオプションの *processMax* 引数は、同時にビルドするコンパイル単位の最大数を指定します。 **/Maxcpucount** オプションで *P* プロジェクトが指定され、 **/mp** オプションで *c* プロセスが指定されている場合、最大で *p* x *c* 個のプロセスが同時に実行されます。

MSBuild または **/mp** テクノロジを使用するかどうかを決定するためのガイドラインは次のとおりです。

- 各プロジェクトに少数のファイルが含まれているプロジェクトが多数ある場合は、MSBuild ツールを使用します。

- プロジェクトの数が少なく、各プロジェクトのファイルが多い場合は、 **/MP** オプションを使用します。

- プロジェクトとプロジェクトごとのファイルの数が均衡になっている場合は、MSBuild と **/mp** の両方を使用します。 初期設定では、 **/maxcpucount** オプションをビルドするプロジェクトの数に設定し、 **/MP** オプションをコンピューター上のプロセッサの数に設定します。 パフォーマンスを測定し、最適な結果を得られるように、設定を調整します。 合計のビルド時間に満足できるまで、このサイクルを繰り返します。

## <a name="see-also"></a>関連項目

[#import ディレクティブ](../../preprocessor/hash-import-directive-cpp.md)<br/>
[コマンドラインリファレンス](/visualstudio/msbuild/msbuild-command-line-reference)<br/>
[/Zf (PDB 生成の高速化)](zf.md)<br/>
